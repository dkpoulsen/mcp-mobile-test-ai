import { jsx as _jsx, jsxs as _jsxs, Fragment as _Fragment } from "react/jsx-runtime";
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { Link, useParams } from 'react-router-dom';
import api from '@/lib/api';
import { Badge } from '@/components/Badge';
import { Button } from '@/components/Button';
import { Card, CardHeader, CardTitle, CardContent } from '@/components/Card';
import { CenteredSpinner } from '@/components/Spinner';
import { getPlatformIcon, formatDuration, formatDate } from '@/lib/utils';
import { ArrowLeft, ChevronLeft, ChevronRight, X } from 'lucide-react';
import { useState } from 'react';
export function TestRunDetail() {
    const { id } = useParams();
    const [resultsPage, setResultsPage] = useState(0);
    const resultsPageSize = 20;
    const queryClient = useQueryClient();
    const { data: run, isLoading: runLoading } = useQuery({
        queryKey: ['run', id],
        queryFn: () => api.getTestRun(id),
        enabled: !!id,
        refetchInterval: (query) => {
            // Refetch if still running
            const status = query.state.data?.data.status;
            return status === 'RUNNING' || status === 'PENDING' ? 3000 : false;
        },
    });
    const { data: resultsData, isLoading: resultsLoading } = useQuery({
        queryKey: ['run', id, 'results', resultsPage],
        queryFn: () => api.getTestRunResults(id, { skip: resultsPage * resultsPageSize, take: resultsPageSize }),
        enabled: !!id,
    });
    const cancelMutation = useMutation({
        mutationFn: () => api.cancelTestRun(id),
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey: ['run', id] });
            queryClient.invalidateQueries({ queryKey: ['runs'] });
        },
    });
    if (runLoading || !run) {
        return _jsx(CenteredSpinner, {});
    }
    const testRun = run.data;
    return (_jsxs("div", { className: "space-y-6", children: [_jsxs("div", { className: "flex items-center gap-4", children: [_jsx(Link, { to: "/test-runs", children: _jsxs(Button, { size: "sm", variant: "ghost", children: [_jsx(ArrowLeft, { className: "mr-2 h-4 w-4" }), "Back to Test Runs"] }) }), _jsxs("div", { className: "flex-1", children: [_jsx("h2", { className: "text-2xl font-bold text-gray-900", children: testRun.testSuite?.name }), _jsxs("p", { className: "text-sm text-gray-600", children: ["ID: ", testRun.id] })] }), (testRun.status === 'PENDING' || testRun.status === 'RUNNING') && (_jsxs(Button, { variant: "danger", onClick: () => cancelMutation.mutate(), disabled: cancelMutation.isPending, children: [_jsx(X, { className: "mr-2 h-4 w-4" }), "Cancel Run"] }))] }), _jsxs("div", { className: "grid gap-6 md:grid-cols-4", children: [_jsx(Card, { children: _jsx(CardContent, { className: "p-6", children: _jsxs("div", { className: "text-center", children: [_jsx("p", { className: "text-sm text-gray-600", children: "Status" }), _jsx(Badge, { variant: "status", status: testRun.status, className: "mt-2", children: testRun.status })] }) }) }), _jsx(Card, { children: _jsx(CardContent, { className: "p-6", children: _jsxs("div", { className: "text-center", children: [_jsx("p", { className: "text-sm text-gray-600", children: "Passed" }), _jsx("p", { className: "mt-2 text-3xl font-bold text-green-600", children: testRun.passedCount })] }) }) }), _jsx(Card, { children: _jsx(CardContent, { className: "p-6", children: _jsxs("div", { className: "text-center", children: [_jsx("p", { className: "text-sm text-gray-600", children: "Failed" }), _jsx("p", { className: "mt-2 text-3xl font-bold text-red-600", children: testRun.failedCount })] }) }) }), _jsx(Card, { children: _jsx(CardContent, { className: "p-6", children: _jsxs("div", { className: "text-center", children: [_jsx("p", { className: "text-sm text-gray-600", children: "Skipped" }), _jsx("p", { className: "mt-2 text-3xl font-bold text-gray-600", children: testRun.skippedCount })] }) }) })] }), _jsxs("div", { className: "grid gap-6 md:grid-cols-2", children: [_jsxs(Card, { children: [_jsx(CardHeader, { children: _jsx(CardTitle, { children: "Device Info" }) }), _jsxs(CardContent, { className: "space-y-2", children: [_jsxs("div", { className: "flex justify-between", children: [_jsx("span", { className: "text-gray-600", children: "Device:" }), _jsxs("span", { className: "font-medium", children: [getPlatformIcon(testRun.device?.platform || 'ANDROID'), " ", testRun.device?.name] })] }), _jsxs("div", { className: "flex justify-between", children: [_jsx("span", { className: "text-gray-600", children: "OS Version:" }), _jsx("span", { className: "font-medium", children: testRun.device?.osVersion })] }), _jsxs("div", { className: "flex justify-between", children: [_jsx("span", { className: "text-gray-600", children: "Type:" }), _jsx("span", { className: "font-medium", children: testRun.device?.isEmulator ? 'Emulator' : 'Real Device' })] })] })] }), _jsxs(Card, { children: [_jsx(CardHeader, { children: _jsx(CardTitle, { children: "Timing" }) }), _jsxs(CardContent, { className: "space-y-2", children: [_jsxs("div", { className: "flex justify-between", children: [_jsx("span", { className: "text-gray-600", children: "Created:" }), _jsx("span", { className: "font-medium", children: formatDate(testRun.createdAt) })] }), _jsxs("div", { className: "flex justify-between", children: [_jsx("span", { className: "text-gray-600", children: "Started:" }), _jsx("span", { className: "font-medium", children: testRun.startedAt ? formatDate(testRun.startedAt) : '-' })] }), _jsxs("div", { className: "flex justify-between", children: [_jsx("span", { className: "text-gray-600", children: "Completed:" }), _jsx("span", { className: "font-medium", children: testRun.completedAt ? formatDate(testRun.completedAt) : '-' })] }), _jsxs("div", { className: "flex justify-between", children: [_jsx("span", { className: "text-gray-600", children: "Duration:" }), _jsx("span", { className: "font-medium", children: testRun.totalDuration ? formatDuration(testRun.totalDuration) : '-' })] })] })] })] }), _jsxs(Card, { children: [_jsx(CardHeader, { children: _jsx(CardTitle, { children: "Test Results" }) }), _jsx(CardContent, { children: resultsLoading ? (_jsx("div", { className: "flex min-h-[200px] items-center justify-center", children: _jsx("div", { className: "text-gray-500", children: "Loading..." }) })) : resultsData && resultsData.data.length > 0 ? (_jsxs(_Fragment, { children: [_jsx("div", { className: "overflow-x-auto", children: _jsxs("table", { className: "w-full", children: [_jsx("thead", { className: "border-b border-gray-200 bg-gray-50", children: _jsxs("tr", { children: [_jsx("th", { className: "px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-600", children: "Test Name" }), _jsx("th", { className: "px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-600", children: "Status" }), _jsx("th", { className: "px-6 py-3 text-right text-xs font-medium uppercase tracking-wider text-gray-600", children: "Duration" }), _jsx("th", { className: "px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-600", children: "Error Message" })] }) }), _jsx("tbody", { className: "divide-y divide-gray-200", children: resultsData.data.map((result) => (_jsxs("tr", { className: "hover:bg-gray-50", children: [_jsxs("td", { className: "px-6 py-4", children: [_jsx("div", { className: "text-sm font-medium text-gray-900", children: result.testCase?.name }), result.testCase?.description && (_jsx("div", { className: "text-xs text-gray-500", children: result.testCase.description }))] }), _jsx("td", { className: "px-6 py-4", children: _jsx(Badge, { variant: "status", status: result.status, children: result.status }) }), _jsx("td", { className: "px-6 py-4 text-right text-sm text-gray-600", children: formatDuration(result.duration) }), _jsx("td", { className: "max-w-md px-6 py-4", children: result.errorMessage ? (_jsx("div", { className: "text-sm text-red-600", children: result.errorMessage })) : (_jsx("span", { className: "text-sm text-gray-400", children: "-" })) })] }, result.id))) })] }) }), resultsData.pagination.totalPages > 1 && (_jsxs("div", { className: "flex items-center justify-between border-t border-gray-200 px-6 py-4", children: [_jsxs("div", { className: "text-sm text-gray-600", children: ["Showing ", resultsPage * resultsPageSize + 1, " to", ' ', Math.min((resultsPage + 1) * resultsPageSize, resultsData.pagination.total), " of", ' ', resultsData.pagination.total, " results"] }), _jsxs("div", { className: "flex items-center gap-2", children: [_jsxs(Button, { size: "sm", variant: "secondary", onClick: () => setResultsPage((p) => Math.max(0, p - 1)), disabled: resultsPage === 0, children: [_jsx(ChevronLeft, { className: "h-4 w-4" }), "Previous"] }), _jsxs("span", { className: "text-sm text-gray-600", children: ["Page ", resultsPage + 1, " of ", resultsData.pagination.totalPages] }), _jsxs(Button, { size: "sm", variant: "secondary", onClick: () => setResultsPage((p) => Math.min(resultsData.pagination.totalPages - 1, p + 1)), disabled: resultsPage >= resultsData.pagination.totalPages - 1, children: ["Next", _jsx(ChevronRight, { className: "h-4 w-4" })] })] })] }))] })) : (_jsx("div", { className: "py-8 text-center text-gray-500", children: "No test results found" })) })] })] }));
}
