# GitHub Actions CI workflow for automated mobile testing
# Triggers on push to main/master and on pull requests

name: Mobile Testing CI

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master, develop]
  workflow_dispatch:

env:
  NODE_VERSION: "20"
  POSTGRES_USER: mcpmobile
  POSTGRES_PASSWORD: mcpmobilepass
  POSTGRES_DB: mcpmobiletest_test
  TEST_POSTGRES_PORT: 5433
  TEST_REDIS_PORT: 6380

jobs:
  # Lint and typecheck job - runs fast, catches issues early
  lint:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint

      - name: Run TypeScript type check
        run: npm run typecheck

      - name: Check Prettier formatting
        run: npm run format

  # Smart test selection - determines which tests to run
  smart-test-selection:
    name: Smart Test Selection
    runs-on: ubuntu-latest
    needs: lint
    if: github.event_name == 'pull_request'
    outputs:
      selected-tests: ${{ steps.selection.outputs.selected-tests }}
      should-run-all: ${{ steps.selection.outputs.should-run-all }}
      selection-summary: ${{ steps.selection.outputs.selection-summary }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run smart test selection
        id: selection
        run: |
          # Run smart test selector
          RESULT=$(npm run test:select:json)
          echo "$RESULT" > selection-result.json

          # Extract selected test count
          SELECTED_COUNT=$(echo "$RESULT" | jq '.selectedCount // 0')
          SHOULD_RUN_ALL=$(echo "$RESULT" | jq '.metadata.config.fullTestThreshold <= .metadata.changedFilesCount')

          echo "selected-tests=$RESULT" >> $GITHUB_OUTPUT
          echo "should-run-all=$SHOULD_RUN_ALL" >> $GITHUB_OUTPUT

          # Generate summary
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## Smart Test Selection Results

          - **Selected Tests:** $SELECTED_COUNT
          - **Skipped Tests:** $(echo "$RESULT" | jq '.skippedCount // 0')
          - **Estimated Time Savings:** $(echo "$RESULT" | jq '.estimatedTimeSavings // 0 | . / 1000') seconds
          - **Selection Confidence:** $(echo "$RESULT" | jq '(.confidence * 100) | floor')%

          ### Selected Tests
          $(echo "$RESULT" | jq -r '.selectedTests[] | "- \(.testPath) (priority: \(.priority * 100 | floor)%)"')
          EOF
        env:
          NODE_ENV: test

      - name: Upload selection result
        uses: actions/upload-artifact@v4
        with:
          name: smart-test-selection-result
          path: selection-result.json

  # Unit tests job - runs on every push/PR
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Smart test selection
        id: selection
        if: github.event_name == 'pull_request'
        run: |
          # Run smart test selector for PRs
          RESULT=$(npm run test:select:json 2>/dev/null || echo '{"selectedTests":[],"selectedCount":0}')
          echo "$RESULT" > selection-result.json

          # Extract selected test count
          SELECTED_COUNT=$(echo "$RESULT" | jq '.selectedCount // 0')
          SHOULD_RUN_ALL=$(echo "$RESULT" | jq '.metadata.config.fullTestThreshold <= .metadata.changedFilesCount')

          echo "should-run-all=$SHOULD_RUN_ALL" >> $GITHUB_OUTPUT
          echo "selected-count=$SELECTED_COUNT" >> $GITHUB_OUTPUT
        continue-on-error: true
        env:
          NODE_ENV: test

      - name: Run selected tests
        id: run-tests
        run: |
          if [ "${{ steps.selection.outputs.should-run-all }}" == "true" ]; then
            echo "Running all tests (exceeds threshold)"
            npm run test
          elif [ -f "selection-result.json" ] && [ "${{ steps.selection.outputs.selected-count }}" != "0" ]; then
            echo "Running selected tests based on smart selection"
            SELECTED_TEST_PATHS=$(cat selection-result.json | jq -r '.selectedTests[].testPath' | tr '\n' ' ')
            if [ -n "$SELECTED_TEST_PATHS" ]; then
              echo "Running: $SELECTED_TEST_PATHS"
              tsx --test $SELECTED_TEST_PATHS
            else
              echo "No tests selected, running all tests"
              npm run test
            fi
          else
            echo "Running all tests"
            npm run test
          fi
        env:
          NODE_ENV: test
          LLM_PROVIDER: mock
          LLM_API_KEY: test-key

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-results
          path: |
            test-reports/
            **/test-results/

  # Integration tests with Docker
  integration-tests:
    name: Integration Tests (Docker)
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Create test environment file
        run: |
          cat > .env.test << EOF
          NODE_ENV=test
          POSTGRES_USER=${{ env.POSTGRES_USER }}
          POSTGRES_PASSWORD=${{ env.POSTGRES_PASSWORD }}
          POSTGRES_DB=${{ env.POSTGRES_DB }}
          TEST_POSTGRES_PORT=${{ env.TEST_POSTGRES_PORT }}
          TEST_REDIS_PORT=${{ env.TEST_REDIS_PORT }}
          LLM_PROVIDER=mock
          LLM_API_KEY=test-key
          LLM_MODEL=gpt-4
          LOG_LEVEL=error
          EOF

      - name: Run Docker integration tests
        run: |
          docker compose -f docker-compose.test.yml up --abort-on-container-exit --build

      - name: Extract test reports from Docker
        if: always()
        run: |
          docker cp mcp-mobile-test-runner:/app/test-reports ./test-reports || true

      - name: Upload test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-reports
          path: test-reports/

      - name: Checkout Docker logs on failure
        if: failure()
        run: docker compose -f docker-compose.test.yml logs

  # Android matrix tests - runs on multiple Android API levels
  android-tests:
    name: Android Tests (API ${{ matrix.api-level }})
    runs-on: ubuntu-latest
    needs: lint
    strategy:
      fail-fast: false
      matrix:
        api-level: [29, 33, 34]
        target: [default]
        arch: [x86_64]
        include:
          - api-level: 29
            api-name: "Android 10"
          - api-level: 33
            api-name: "Android 13"
          - api-level: 34
            api-name: "Android 14"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Enable KVM group perms
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: AVD cache
        uses: actions/cache@v4
        id: avd-cache
        with:
          path: |
            ~/.android/avd/*
            ~/.android/adb*
          key: avd-${{ matrix.api-level }}-${{ matrix.arch }}

      - name: Create AVD and generate snapshot for caching
        if: steps.avd-cache.outputs.cache-hit != 'true'
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: ${{ matrix.api-level }}
          target: ${{ matrix.target }}
          arch: ${{ matrix.arch }}
          force-avd-creation: false
          emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none
          disable-animations: false
          script: echo "Generated AVD snapshot for caching."

      - name: Run Android tests
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: ${{ matrix.api-level }}
          target: ${{ matrix.target }}
          arch: ${{ matrix.arch }}
          force-avd-creation: false
          emulator-options: -no-snapshot-save -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none
          disable-animations: true
          script: |
            npm run test -- tests/android/
        env:
          ANDROID_PLATFORM: true
          ANDROID_API_LEVEL: ${{ matrix.api-level }}

      - name: Upload Android test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: android-test-results-api-${{ matrix.api-level }}
          path: |
            test-results/
            **/test-results/

  # iOS matrix tests - runs on multiple iOS versions (macOS only)
  ios-tests:
    name: iOS Tests (${{ matrix.os-version }})
    runs-on: macos-14
    needs: lint
    strategy:
      fail-fast: false
      matrix:
        os-version: [ios-17, ios-18]
        device-type: [iPhone 14]
        include:
          - os-version: ios-17
            runtime-id: com.apple.CoreSimulator.SimRuntime.iOS-17-5
          - os-version: ios-18
            runtime-id: com.apple.CoreSimulator.SimRuntime.iOS-18-2

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: List available simulators
        run: xcrun simctl list devices available

      - name: Boot iOS simulator
        run: |
          DEVICE_UUID=$(xcrun simctl create "Test iPhone" ${{ matrix.device-type }} ${{ matrix.os-version }})
          echo "DEVICE_UUID=$DEVICE_UUID" >> $GITHUB_ENV
          xcrun simctl boot "$DEVICE_UUID"
          xcrun simctl bootstatus "$DEVICE_UUID" || true

      - name: Run iOS tests
        run: npm run test -- tests/ios/
        env:
          IOS_PLATFORM: true
          IOS_SIMULATOR_UUID: ${{ env.DEVICE_UUID }}

      - name: Shutdown simulator
        if: always()
        run: |
          xcrun simctl shutdown ${{ env.DEVICE_UUID }} || true

      - name: Upload iOS test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ios-test-results-${{ matrix.os-version }}
          path: |
            test-results/
            **/test-results/

  # E2E tests with Playwright
  e2e-tests:
    name: E2E Tests (Playwright)
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run Playwright tests
        run: npx playwright test
        env:
          CI: true

      - name: Upload Playwright test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-test-results
          path: |
            playwright-report/
            test-results/

      - name: Upload Playwright HTML report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-html-report
          path: playwright-report/

  # Build verification
  build:
    name: Build Verification
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build TypeScript
        run: npm run build

      - name: Build dashboard
        run: npm run dashboard:build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            dist/
            dashboard/dist/

  # Test results summary and reporting
  test-report:
    name: Test Results Summary
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, android-tests, ios-tests, e2e-tests, build]
    if: always()
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-test-results

      - name: Generate test summary
        run: |
          echo "# Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Workflow Run: ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Job Status" >> $GITHUB_STEP_SUMMARY
          echo "- Lint & Type Check: ${{ needs.lint.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Unit Tests: ${{ needs.unit-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Integration Tests: ${{ needs.integration-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Android Tests: ${{ needs.android-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- iOS Tests: ${{ needs.ios-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- E2E Tests: ${{ needs.e2e-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Build: ${{ needs.build.result }}" >> $GITHUB_STEP_SUMMARY

      - name: Check test results
        run: |
          if [[ "${{ needs.unit-tests.result }}" == "failure" ]] || \
             [[ "${{ needs.integration-tests.result }}" == "failure" ]] || \
             [[ "${{ needs.build.result }}" == "failure" ]]; then
            echo "::error::One or more critical test jobs failed"
            exit 1
          fi

      - name: Publish test results
        if: always()
        uses: EnricoMi/publish-unit-test-result-action@v2
        with:
          files: |
            all-test-results/**/*.xml
            all-test-results/**/*.json
          check_name: Test Results
          comment_title: Test Results Summary

  # Status check - ensures all required jobs pass
  status-check:
    name: CI Status Check
    runs-on: ubuntu-latest
    needs: [lint, unit-tests, integration-tests, build]
    if: always()
    steps:
      - name: Check all required jobs
        run: |
          if [[ "${{ needs.lint.result }}" == "failure" ]] || \
             [[ "${{ needs.unit-tests.result }}" == "failure" ]] || \
             [[ "${{ needs.integration-tests.result }}" == "failure" ]] || \
             [[ "${{ needs.build.result }}" == "failure" ]]; then
            echo "::error::CI failed - one or more required jobs failed"
            exit 1
          fi
          echo "All required CI jobs passed successfully"
